<!DOCTYPE html>
<html>
<body>

<div id="controls">
    <button id="bStop" style="width:10%">Stop</button>
    <span style="width:10%">Answer:</span>
    <input id="iAnswer" type="text" style="width:68%"></input>
    <button id="bSubmit" style="width:10%">Submit</button>
</div>

<canvas id="myCanvas" width="100%" height="90%" style="border:0px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.
</canvas>

<img class="PlaceImage" width="0" height="0" src="tst.png" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/twickenham.jpg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/sydney.jpg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/Rojales.jpeg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/GoldenGatBridge.jpg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/beehive bro 2.jpg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/xscape-building.jpg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/stonehenge.jpg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/ChippingNorton.jpg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/TajMahaal.jpg" style="visibility: hidden">
<img class="PlaceImage" width="0" height="0" src="Places/BigBen.jpg" style="visibility: hidden">

<img class="AnimalImage" width="0" height="0" src="tst.png" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/Girafe.jpeg" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/Zebra.jpg" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/albatross.jpg" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/cat.jpg" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/cheetahs_2858137a.webp" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/clown-fish.jpg" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/elephants.jpeg" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/flatcoat.jpg" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/hedgehog.jpeg" style="visibility: hidden">
<img class="AnimalImage" width="0" height="0" src="Animals/komodo-dragon.jpg" style="visibility: hidden">

<div id="ResultsForm" style="visibility: hidden; width:100%; height:100%; position:absolute; top:0%; left:0%">
    <form id="round0Results"></form>
    <form id="round1Results"></form>
</div>

<div id="instructions" style="position:absolute; top:5%; left:5%;">
    <h2>Remember:</h2>
    <h3>To Stop the Clock:</h3>
    <p> - Click on the Stop button</p>
    <p> - Click on the image while the clock is running</p>
    <p> - Click on the answer box</p>
    <h3>To Resume the Clock:</h3>
    <p> - Click on the "Go" button</p>
    <p> - Click on the image while the clock is stopped</p>
</div>

<button id="bStart" style="position:absolute; top:40%; left:40%;">Start Playing</button>

<script>
var canvas = document.getElementById("myCanvas");
canvas.width  = window.innerWidth;
canvas.height = window.innerHeight * 0.9;
var ctx = canvas.getContext("2d");

var currentMultiplier = 0.01;
var currentPx = function(img) 
{ 
    return img.naturalWidth * currentMultiplier;
};

var currentPy = function(img) 
{ 
    return img.naturalHeight * currentMultiplier;
};

var currentStartX = function(img)
{
    return (img.naturalWidth - currentPx(img)) * 0.5;
}

var currentStartY = function(img)
{
    return (img.naturalHeight - currentPy(img)) * 0.5;
}

function getImages(roundIndex)
{
    if (roundIndex == 0)
        return document.getElementsByClassName("PlaceImage");
    if (roundIndex == 1)
        return document.getElementsByClassName("AnimalImage");

    return null;
}

const sleep = (milliseconds) => {
  return new Promise(resolve => setTimeout(resolve, milliseconds))
}

var currentRoundIndex = 0;
var currentImageIndex = 0;
var instructions = document.getElementById("instructions");

const runGame = async () => 
{
    document.getElementById("bStart").style.visibility = "hidden";
    instructions.style.visibility = "hidden";

    canvas.style.visibility = "visible";
    document.getElementById("controls").style.visibility = "visible";

    var images = getImages(currentRoundIndex);

    while (images != null)
    {
        for (currentImageIndex = 0; currentImageIndex < images.length; currentImageIndex += 1)
        {
            answered = false;
            await runGameForImage(images[currentImageIndex]);
            break;
        }

        currentRoundIndex += 1;
        images = getImages(currentRoundIndex);
    }

    showResults();
}

function showResults()
{
    canvas.style.visibility = "hidden";
    document.getElementById("controls").style.visibility = "hidden";
    let resultsForm = document.getElementById("ResultsForm")
    resultsForm.style.visibility = "visible";
    resultsForm.style.left = 10;
}

function onStop(val)
{
    if (val)
    {
        clicked = true;
        document.getElementById("bStop").innerHTML = "Go";
    }
    else
    {
        clicked = false;
        document.getElementById("bStop").innerHTML = "Stop";
    }
}

document.getElementById("bStop").onclick = function()
{
    if (clicked == true)
        onStop(false);
    else
        onStop(true);
}

var millisecondsPerFrame = 500;
const runGameForImage = async (image) =>
{
    currentMultiplier = 0.01;
    while (currentMultiplier <= 0.9)
    {
        while (clicked == true && answered == false) 
        {
            console.log("sleeping");
            await sleep(10);
        }
        if (answered == true)
        {
            console.log("got answer");
            break;
        }

        ctx.drawImage(image, currentStartX(image), currentStartY(image), currentPx(image), currentPy(image), 0, 0, window.innerWidth, window.innerHeight);
        await sleep(millisecondsPerFrame);
        currentMultiplier += 0.01;
    }
}

var clicked = false;
canvas.onclick = function() 
{ 
    if (clicked)
        onStop(false);
    else 
        onStop(true);
}

function addResult(roundIndex, questionIndex, time, answer)
{
    let formName = "round" + String(roundIndex) + "Results";
    let form = document.getElementById(formName);

    let label = document.createElement("label");
    label.innerHTML = "    (" + String(roundIndex) + ":" + String(questionIndex) + ")  \"" + String(answer) + "\" in " + String(time * (millisecondsPerFrame / 1000) / 0.01) + "s";

    let br = document.createElement("br");
    form.appendChild(label);
    form.appendChild(br);
}

var answer = document.getElementById("iAnswer");
answer.onfocus = function(){ onStop(true); }

var answered = false;
var submitButton = document.getElementById("bSubmit");
submitButton.onclick = function()
{
    onStop(true);
    if (answer.value == "")
    {
        alert("You need to type you answer in the box above the image. I've made sure it's paused so don't worry, it won't affect your score!");
        return;
    }
    
    addResult(currentRoundIndex, currentImageIndex, currentMultiplier, answer.value);
    answer.value = "";
    
    answered = true;
    onStop(false);
}

canvas.style.visibility = "hidden";
document.getElementById("controls").style.visibility = "hidden";

document.getElementById("bStart").onclick = runGame;

</script>
